<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Student</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f4f4f4; }
    .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border: 1px solid #ccc; }
    label { display: block; font-weight: bold; margin-top: 15px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 15px; }
    h2, h3 { text-align: center; margin-top: 30px; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    .section { margin-top: 30px; }
  </style>
</head>
<body>
<div class="container">
  <h2>Edit Student Record</h2>
  <form method="POST" action="/Staff/Management/students/edit/<%= student._id %>">
    <input type="hidden" name="id" value="<%= student._id %>"/>

    <!-- Basic Fields -->
     <label>Course</label>
      <input name="course" value="<%= student.course %>" required />

      <label>First Name</label>
      <input name="firstName" value="<%= student.firstName %>" required />

      <label>Middle Name</label>
      <input name="middleName" value="<%= student.middleName || '' %>" />

      <label>Last Name</label>
      <input name="lastName" value="<%= student.lastName %>" required />

      <label>Gender</label>
      <input name="gender" value="<%= student.gender %>" required />

      <label>Email</label>
      <input name="studentEmail" value="<%= student.studentEmail %>" required />

      <label>Phone</label>
      <input name="studentPhone" value="<%= student.studentPhone %>" required />

      <label>DOB</label>
      <input name="dob" type="date" value="<%= student.dob.toISOString().split('T')[0] %>" required />

      <label>Password (Hashed)</label>
      <input name="password" value="<%= student.password %>" />

      <label>Guardian 1 Name</label>
      <input name="guardian1Name" value="<%= student.guardian1Name %>" required />

      <label>Guardian 1 Relation</label>
      <input name="guardian1Relation" value="<%= student.guardian1Relation %>" required />

      <label>Guardian 1 Email</label>
      <input name="guardian1Email" value="<%= student.guardian1Email || '' %>" />

      <label>Guardian 1 Phone</label>
      <input name="guardian1Phone" value="<%= student.guardian1Phone %>" required />

      <label>Guardian 2 Name</label>
      <input name="guardian2Name" value="<%= student.guardian2Name || '' %>" />

      <label>Guardian 2 Relation</label>
      <input name="guardian2Relation" value="<%= student.guardian2Relation || '' %>" />

      <label>Address Line 1</label>
      <input name="address1" value="<%= student.address1 %>" required />

      <label>Address Line 2</label>
      <input name="address2" value="<%= student.address2 || '' %>" />

      <label>City</label>
      <input name="city" value="<%= student.city %>" required />

      <label>State</label>
      <input name="state" value="<%= student.state %>" required />

      <label>Zip Code</label>
      <input name="zipcode" value="<%= student.zipcode %>" required />

      <label>Country</label>
      <input name="country" value="<%= student.country %>" required />

      <label>Registration No.</label>
      <input name="registration_number" value="<%= student.registration_number || '' %>" />

      <label>Subjects (comma-separated)</label>
      <input name="subjects" value="<%= student.subjects?.join(', ') || '' %>" />

      <label>Class Assigned</label>
      <input name="classAssigned" value="<%= student.classAssigned || '' %>" />

      <label>Joining Date</label>
      <input type="date" name="joiningDate" value="<%= student.joiningDate ? student.joiningDate.toISOString().split('T')[0] : '' %>" />

      <label>Academic Year</label>
      <input name="academicYear" value="<%= student.academicYear || '' %>" />

      <label>Batch</label>
      <input name="batch" value="<%= student.batch || '' %>" />

      <label>Session</label>
      <input name="academicSession" value="<%= student.academicSession || '' %>" />

      <label>Fees Due</label>
      <input name="feesDue" type="number" value="<%= student.feesDue || 0 %>" />

      <label>Current Semester</label>
      <input name="currentSemester" value="<%= student.currentSemester || '' %>" />

      <!-- Enrolled/Hostel/etc checkboxes -->
      <label><input type="checkbox" name="isEnrolled" <%= student.isEnrolled ? 'checked' : '' %>> Enrolled</label>
      <label><input type="checkbox" name="isHostelResident" <%= student.isHostelResident ? 'checked' : '' %>> Hostel</label>
      <label><input type="checkbox" name="isTransportResident" <%= student.isTransportResident ? 'checked' : '' %>> Transport</label>
      <label><input type="checkbox" name="isPromoted" <%= student.isPromoted ? 'checked' : '' %>> Promoted</label>
      <label><input type="checkbox" name="isGraduated" <%= student.isGraduated ? 'checked' : '' %>> Graduated</label>


    <!-- RESULT TABLE -->
    <div class="section">
      <h3>Results</h3>
      <div id="results-container">
        <% (student.result || []).forEach((r, i) => { %>
          <div class="result-block" data-index="<%= i %>">
            <h4>Result <%= i + 1 %></h4>
            <label>Exam Type</label>
            <input name="result[<%= i %>][examType]" value="<%= r.examType %>" required />
            <label>SGPA</label>
            <input name="result[<%= i %>][sgpa]" value="<%= r.sgpa %>" />
            <label>CGPA</label>
            <input name="result[<%= i %>][cgpa]" value="<%= r.cgpa %>" />

            <h5>Subjects</h5>
            <table>
              <thead>
                <tr><th>Name</th><th>Marks</th><th>Grade</th><th>Action</th></tr>
              </thead>
              <tbody>
              <% (r.subjects || []).forEach((s, j) => { %>
                <tr>
                  <td><input name="result[<%= i %>][subjects][<%= j %>][name]" value="<%= s.name %>" required></td>
                  <td><input name="result[<%= i %>][subjects][<%= j %>][marks]" type="number" value="<%= s.marks %>" required></td>
                  <td><input name="result[<%= i %>][subjects][<%= j %>][grade]" value="<%= s.grade %>"></td>
                  <td><button type="button" class="removeRow">Remove</button></td>
                </tr>
              <% }) %>
              </tbody>
            </table>
            <button type="button" class="addSubjectBtn" data-result="<%= i %>">Add Subject</button>
          </div>
        <% }) %>
      </div>
      <button type="button" id="addResultBtn">Add Result</button>
    </div>

    <!-- ATTENDANCE -->
    <div class="section">
      <h3>Attendance</h3>
      <table id="attendanceTable">
        <thead><tr><th>Subject</th><th>Attended</th><th>Total</th><th>Action</th></tr></thead>
        <tbody>
        <% (student.attendance || []).forEach((a, i) => { %>
          <tr>
            <td><input name="attendance[<%= i %>][subject]" value="<%= a.subject %>" required></td>
            <td><input name="attendance[<%= i %>][attended]" value="<%= a.attended %>" required></td>
            <td><input name="attendance[<%= i %>][totalClasses]" value="<%= a.totalClasses %>" required></td>
            <td><button type="button" class="removeRow">Remove</button></td>
          </tr>
        <% }) %>
        </tbody>
      </table>
      <button type="button" id="addAttendanceBtn">Add Attendance</button>
    </div>

    <!-- DOCUMENTS -->
    <div class="section">
      <h3>Documents</h3>
      <table id="documentTable">
        <thead><tr><th>Name</th><th>URL</th><th>Uploaded At</th><th>Action</th></tr></thead>
        <tbody>
        <% (student.documents || []).forEach((d, i) => { %>
          <tr>
            <td><input name="documents[<%= i %>][name]" value="<%= d.name %>" /></td>
            <td><input name="documents[<%= i %>][url]" value="<%= d.url %>" /></td>
            <td><input type="datetime-local" name="documents[<%= i %>][uploadedAt]" value="<%= new Date(d.uploadedAt).toISOString().slice(0,16) %>" /></td>
            <td><button type="button" class="removeRow">Remove</button></td>
          </tr>
        <% }) %>
        </tbody>
      </table>
      <button type="button" id="addDocumentBtn">Add Document</button>
    </div>

    <!-- PAYMENT HISTORY -->
    <div class="section">
      <h3>Payment History</h3>
      <table id="paymentTable">
        <thead><tr><th>Amount</th><th>Date</th><th>Mode</th><th>Receipt #</th><th>Action</th></tr></thead>
        <tbody>
        <% (student.paymentHistory || []).forEach((p, i) => { %>
          <tr>
            <td><input name="paymentHistory[<%= i %>][amount]" value="<%= p.amount %>" /></td>
            <td><input type="datetime-local" name="paymentHistory[<%= i %>][date]" value="<%= new Date(p.date).toISOString().slice(0,16) %>" /></td>
            <td><input name="paymentHistory[<%= i %>][mode]" value="<%= p.mode %>" /></td>
            <td><input name="paymentHistory[<%= i %>][receiptNumber]" value="<%= p.receiptNumber %>" /></td>
            <td><button type="button" class="removeRow">Remove</button></td>
          </tr>
        <% }) %>
        </tbody>
      </table>
      <button type="button" id="addPaymentBtn">Add Payment</button>
    </div>

    <button type="submit">Update Student</button>
  </form>

  <form method="POST" action="/Staff/Management/students/delete/<%= student._id %>">
    <button type="submit" style="background:red;color:white;">Delete Student</button>
  </form>
</div>

<!-- ... your current <html> and <head> as-is ... -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  const removeRow = (e) => {
    if (e.target.classList.contains('removeRow')) {
      e.target.closest('tr').remove();
    }
  };
  document.body.addEventListener('click', removeRow);

  // Add Attendance Row
  document.getElementById('addAttendanceBtn').addEventListener('click', () => {
    const tbody = document.querySelector('#attendanceTable tbody');
    const index = tbody.children.length;
    const row = `
      <tr>
        <td><input name="attendance[${index}][subject]" required /></td>
        <td><input name="attendance[${index}][attended]" required /></td>
        <td><input name="attendance[${index}][totalClasses]" required /></td>
        <td><button type="button" class="removeRow">Remove</button></td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
  });

  // Add Result Block
  document.getElementById('addResultBtn').addEventListener('click', () => {
    const container = document.getElementById('results-container');
    const i = container.children.length;
    const block = `
      <div class="result-block" data-index="${i}">
        <h4>Result ${i + 1}</h4>
        <label>Exam Type</label>
        <input name="result[${i}][examType]" required />
        <label>SGPA</label>
        <input name="result[${i}][sgpa]" />
        <label>CGPA</label>
        <input name="result[${i}][cgpa]" />
        <h5>Subjects</h5>
        <table>
          <thead><tr><th>Name</th><th>Marks</th><th>Grade</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
        <button type="button" class="addSubjectBtn" data-result="${i}">Add Subject</button>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', block);
  });

  // Add Subject Row inside Result
  document.body.addEventListener('click', (e) => {
    if (e.target.classList.contains('addSubjectBtn')) {
      const i = e.target.dataset.result;
      const resultBlock = e.target.closest('.result-block');
      const tbody = resultBlock.querySelector('tbody');
      const j = tbody.children.length;
      const row = `
        <tr>
          <td><input name="result[${i}][subjects][${j}][name]" required /></td>
          <td><input name="result[${i}][subjects][${j}][marks]" type="number" required /></td>
          <td><input name="result[${i}][subjects][${j}][grade]" /></td>
          <td><button type="button" class="removeRow">Remove</button></td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', row);
    }
  });

  // Add Document Row
  document.getElementById('addDocumentBtn').addEventListener('click', () => {
    const tbody = document.querySelector('#documentTable tbody');
    const index = tbody.children.length;
    const now = new Date().toISOString().slice(0, 16); // for datetime-local
    const row = `
      <tr>
        <td><input name="documents[${index}][name]" /></td>
        <td><input name="documents[${index}][url]" /></td>
        <td><input type="datetime-local" name="documents[${index}][uploadedAt]" value="${now}" /></td>
        <td><button type="button" class="removeRow">Remove</button></td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
  });

  // Add Payment Row
  document.getElementById('addPaymentBtn').addEventListener('click', () => {
    const tbody = document.querySelector('#paymentTable tbody');
    const index = tbody.children.length;
    const now = new Date().toISOString().slice(0, 16);
    const row = `
      <tr>
        <td><input name="paymentHistory[${index}][amount]" /></td>
        <td><input type="datetime-local" name="paymentHistory[${index}][date]" value="${now}" /></td>
        <td><input name="paymentHistory[${index}][mode]" /></td>
        <td><input name="paymentHistory[${index}][receiptNumber]" /></td>
        <td><button type="button" class="removeRow">Remove</button></td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
  });
});
</script>

</body>
</html>
